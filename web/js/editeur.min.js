/*!
 * editeur.min.js
 * Fonctions nécessaires à l'édition / à la lecture d'un fichier
 *  - Composé de editeur.js et general.js
 *  - Requiere Jquery
 */
function creer(){var a={nom:$("#nomFichier").val(),donneur:$("#donneurFichier").val(),partage:$("#priveFichier").is(":checked")?"prive":"public"};$.ajax({type:"GET",url:"fonctions/fichier.php?add="+JSON.stringify(a),dataType:"text"}).success(function(a){""===a?erreur({titre:"Echec de la création du fichier.",contenu:"Les données ont été envoyées au serveur qui a détecté une erreur. Veuillez remplir correctement les différentes parties du formulaire."}):(window.location.hash="#"+a,ouvrir("fonctions/fichier.php?f="+a))}).error(function(){erreur({titre:"Echec de comunication avec le serveur.",contenu:"L'envoit des données au serveur a échoué. Réessayez plus tard."})}),$("#fenCreer").modal("hide")}function ouvrir(a){$.getJSON(a,function(a){contenu=a.contenu,fichiers=a.fichiers,comptes=a.comptes,$(".rm_on_file_change").remove();for(var b in fichiers){var c=$("<li><a></a></li>").addClass("rm_on_file_change");c.find("a").text(fichiers[b].nom).attr("href","#"+fichiers[b].fichier),c.prependTo("#liste_fichiers")}$("#liste_fichiers>li>a").click(function(a){ouvrir("fonctions/fichier.php?f="+$(a.currentTarget).attr("href").split("#")[1])}),lire(contenu)}),$("#recherche").val("")}function envoyer(){$("#envoyer").removeClass("btn-danger btn-success").attr("disabled",!0),$.ajax({type:"GET",url:"fonctions/fichier.php?f="+ancre()+"&content="+JSON.stringify(contenu),dataType:"text"}).success(function(){$("#envoyer").addClass("btn-success").attr("disabled",!1)}).error(function(){$("#envoyer").addClass("btn-danger").attr("disabled",!1),erreur({titre:"Echec de l'enregistrement !",contenu:"Impossible de comuniquer les modifications au serveur"})})}function inserer(){var a=$("#ligne_ajout .liste-date").val().split("/"),b=new Date(a[2],a[1]-1,a[0]),c={titre:$("#ligne_ajout .liste-titre").val(),date:b/1e3,montant:parseFloat($("#ligne_ajout .liste-montant").val()),description:$("#ligne_ajout .liste-description").val()};contenu.liste.unshift(c),actualiser(),envoyer(),$("#ajouter_ligne").attr("disabled",!1),$("#ligne_ajout").hide(),console.info("Ajout de ligne : "),console.info(c)}function ajouterLigne(){var a=$("#ligne_ajout");a.find("input.liste-date").datepicker({dateFormat:"dd/mm/yy",beforeShow:function(){setTimeout(function(){$("#ui-datepicker-div").css("z-index",99999999999)},0)}}),$("#ajouter_ligne").attr("disabled",!0),a.show(),$($(".input_ligne")[0]).focus()}function actualiser(){$(".ligne_info").remove(),lire(contenu),filtrer()}function lire(a){stats={total:{depense:0,rembourse:0},mois:{depense:0,rembourse:0}},majStats({montant:0});for(var b in a)console.info(b+" : "+a[b]),$(".doc_info."+b).text(a[b]);$(".doc_info.receveur_pseudo").text(comptes[a.receveur]),$(".doc_info.donneur_pseudo").text(comptes[a.donneur]),$(".dl.json").attr("href","fonctions/fichier.php?raw=json&f="+ancre()),$(".dl.csv").attr("href","fonctions/fichier.php?raw=csv&f="+ancre());for(var c in a.liste)lireLigne(a.liste[c]),$("#liste .ligne_info:last").attr("ligne",c);changerDates(),$(".tt").tooltip()}function lireLigne(a){var b=$("#liste>tr:first").clone().show().addClass("rm_on_file_change ligne_info");for(var c in a)b.find(".doc_info.liste-"+c).text(a[c]);a.refuse===!0?b.addClass("danger"):a.montant<0&&b.addClass("success"),date=new Date(1e3*a.date),b.find(".doc_info.status_icone .glyphicon-info-sign").popover({placement:"left",title:a.titre+" ("+a.montant+" €)",content:date.toLocaleDateString()+" - "+a.description,trigger:"hover click"}),b.find(".icone_tr .refuse").click(function(a){var b=parseInt($(a.target).parent().parent().attr("ligne"));contenu.liste[b].refuse=!contenu.liste[b].refuse,actualiser(),envoyer()}),b.appendTo("#liste"),majStats(a)}function majStats(a){console.debug(a);var b=new Date(1e3*a.date),c=new Date;if(!a.refuse){var d=a.montant>0?"depense":"rembourse";b.getFullYear()==c.getFullYear()&&b.getMonth()==c.getMonth()&&(stats.mois[d]+=Math.abs(a.montant)),stats.total[d]+=Math.abs(a.montant),$(".stats.total").text(stats.total.depense-stats.total.rembourse+" €"),$(".stats.tout.depense").text(stats.total.depense+" €"),$(".stats.tout.rembourse").text(stats.total.rembourse+" €"),$(".stats.mois.depense").text(stats.mois.depense+" €"),$(".stats.mois.rembourse").text(stats.mois.rembourse+" €")}}function filtrer(){$("#liste>tr").each(function(a,b){if(a>1){var c=$("#recherche").val().toUpperCase(),d=$(b).text().toUpperCase();-1==d.indexOf(c)?$(b).hide():$(b).show()}})}function changerDates(){$(".time-date").each(function(a,b){var c=parseInt($(b).text());if(!isNaN(c)){var d=new Date(1e3*c);$(b).text(d.toLocaleDateString()),$(b).attr("title",d.toDateString())}})}function ancre(){var a=window.location.hash;return a=a.substring(1,a.length)}function erreur(a){var b=$("#liste-alertes div:first").clone().show().addClass("rm_on_file_change");b.find(".titre-alerte").text(a.titre),b.find(".contenu-alerte").text(a.contenu),b.appendTo("#liste-alertes")}var contenu={},fichiers={},comptes={},stats={};$(document).ready(function(){ouvrir("fonctions/fichier.php?f="+ancre()),$("#ajouter_ligne").attr("disabled",!1),$("#recherche").keyup(filtrer),$("#ajouter_ligne").click(ajouterLigne),$("#envoyer").click(envoyer),$("#creerFichier").click(creer),$("#inserer").click(inserer),$("#ligne_ajout input").keypress(function(a){13==a.which&&inserer()})});